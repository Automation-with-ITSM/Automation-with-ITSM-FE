name: Update issue from Jira

on:
  repository_dispatch:
    types: [jira-issue-updated]

permissions:
  contents: read
  issues: write

jobs:
  update-issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Render and patch existing issue
        uses: actions/github-script@v7
        with:
          script: |
            const p = context.payload.client_payload || {};
            const esc = (s) => (s ?? '').toString();
            const nz  = (s, f='') => { const v = esc(s).trim(); return v ? v : f; };

            // 0) í•„ìˆ˜ ê°’ í™•ì¸
            const number = Number(p.issue_number);
            if (!number) {
              core.setFailed('Missing issue_number in payload'); 
              return;
            }

            // 1) kind ì •ê·œí™” (story/bug/task)
            const rawKind = esc(p.kind).toLowerCase();
            let kind = 'task';
            if (rawKind.startsWith('story')) kind = 'story';
            else if (rawKind.startsWith('bug')) kind = 'bug';

            // 2) ë³¸ë¬¸ ì¬êµ¬ì„± (í…œí”Œë¦¿ ì—†ì´ Markdown ì¡°ë¦½)
            const bodyLines = [
              '## ğŸ“„ ì´ìŠˆ ê°œìš” (Description)',
              esc(p.description),
              '',
              '---',
              '',
              '### ğŸ§‘â€ğŸ’» ìƒì„±ì',
              esc(p.initiator),
              '',
              '---',
              '',
              '### ğŸ¯ ìš°ì„ ìˆœìœ„',
              esc(p.priority),
              '',
              '---',
              '',
              '### ğŸ“… ê¸°í•œ',
              nz(p.duedate, 'ë¯¸ì •'),
              '',
              '---',
              '',
              '### ğŸ”— Jira Link',
              `[${esc(p.key)}](${esc(p.url)})`
            ];
            const body = bodyLines.join('\n');

            // 3) ë¼ë²¨ ë™ê¸°í™” ê·œì¹™
            //    - Story: ["Story"]
            //    - Bug:   ["Bug"]
            //    - Task:  Jira labels ì¤‘ Feature/Refactor/Documentationë§Œ í—ˆìš©(ëŒ€ì†Œë¬¸ì ë³´ì •)
            const allowed = new Set(['Feature','Refactor','Documentation']);
            let labels = [];
            if (kind === 'story') {
              labels = ['Story'];
            } else if (kind === 'bug') {
              labels = ['Bug'];
            } else {
              let incoming = [];
              if (Array.isArray(p.labels)) incoming = p.labels;
              else if (typeof p.labels === 'string') incoming = p.labels.split(',').map(s=>s.trim()).filter(Boolean);
              const toTitle = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : s;
              labels = incoming.map(toTitle).filter(v => allowed.has(v));
              if (labels.length === 0) labels = ['Task']; // í•„ìš” ì—†ìœ¼ë©´ ì œê±° ê°€ëŠ¥
            }

            // 4) ì œëª© ê°±ì‹ 
            const title = `[${esc(p.key)}] ${esc(p.summary)}`;

            // 5) GitHub Issue Patch
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              title,
              body
            });

            // 6) ë¼ë²¨ ë®ì–´ì“°ê¸°
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              labels
            });

            core.info(`Patched issue #${number} (kind=${kind}, labels=${JSON.stringify(labels)})`);

      - name: Write back issue number to Jira
        uses: actions/github-script@v7
        env:
          JIRA_BASE: https://automation-itsm.atlassian.net
          JIRA_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const p = context.payload.client_payload || {};
            const key = p.key; // e.g., SCRUM-86
            const number = String((await github.rest.issues.get({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.payload.client_payload && context.payload.client_payload._fake ? 0 : 0 // dummy to keep types; we already have number from creation step if needed
            })).data.number) // <- ê°„ë‹¨íˆ ì„¤ëª…: ì´ë¯¸ ìœ— ìŠ¤í…ì—ì„œ res.data.numberë¥¼ ë³€ìˆ˜ì— ë‹´ì•˜ë‹¤ë©´ ê·¸ ê°’ì„ ê·¸ëŒ€ë¡œ ì“°ì„¸ìš”.
      
            // ì‹¤ì œë¡œëŠ” ìœ„ create stepì—ì„œ res.data.numberë¥¼ outputsë¡œ ë„˜ê¸°ê±°ë‚˜ ë™ì¼ ìŠ¤í… ë‚´ë¶€ ë³€ìˆ˜ë¡œ ì“°ë©´ ë©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ number ë³€ìˆ˜ë¥¼ í™•ë³´í–ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
      
            const fetch = require('node-fetch');
            const resp = await fetch(`${process.env.JIRA_BASE_URL}/rest/api/3/issue/${encodeURIComponent(key)}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'Basic ' + Buffer.from(`${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')
              },
              body: JSON.stringify({
                fields: {
                  customfield_gh_number: number
                }
              })
            });
            if (!resp.ok) {
              core.setFailed(`Failed to write GH number to Jira: ${resp.status} ${await resp.text()}`);
            }
